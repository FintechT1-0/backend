- name: Deploy to Droplet via SSH
  uses: appleboy/ssh-action@v0.1.10
  with:
    host: ${{ secrets.DROPLET_HOST }}
    username: ${{ secrets.DROPLET_USER }}
    password: ${{ secrets.DROPLET_PASSWORD }}
    script: |
      IMAGE=${{ secrets.DOCKER_REGISTRY }}/fastapi-app:$(git rev-parse --short HEAD)
      
      # Login to DigitalOcean Registry
      echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      # Pull the new image
      docker pull $IMAGE

      # Stop and remove old container if exists
      docker stop fastapi-app || true
      docker rm fastapi-app || true

      # Run new container
      docker run -d \
        --name fastapi-app \
        -p 80:8000 \
        -e DATABASE_URL=${{ secrets.DATABASE_URL }} \
        -e SECRET_KEY=${{ secrets.SECRET_KEY }} \
        -e ALGORITHM=${{ secrets.ALGORITHM }} \
        -e ACCESS_TOKEN_EXPIRE_MINUTES=${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }} \
        -e CORS_DEBUG_MODE=${{ secrets.CORS_DEBUG_MODE }} \
        -e TRUSTED_ORIGIN=${{ secrets.TRUSTED_ORIGIN }} \
        $IMAGE
